= content_for :head do
  = javascript_include_tag "https://js.stripe.com/v1/"
  :javascript
    Stripe.setPublishableKey('#{STRIPE_PUBLISHABLE_KEY}');

    $(document).ready(function() {
      $(".payment-form").submit(function(event) {
        $('.payment-form .btn').attr("disabled", "disabled"); // prevent repeated clicks
        $('.payment-form .alert-message').hide();

        var amount = $('input[name=amount]').val().replace(/[^0-9\.]+/g,"")*100

        Stripe.createToken({
            number: $('.card-number').val(),
            cvc: $('.card-cvc').val(),
            exp_month: $('.card-expiry-month').val(),
            exp_year: $('.card-expiry-year').val()
        }, amount, stripeResponseHandler);

        return false; // prevent the form from submitting
      });
    });

    function stripeResponseHandler(status, response) {
      if (response.error) {
        $('.payment-form .alert-message p').html(response.error.message);
        $('.payment-form .alert-message').show();
        $('.payment-form .btn').removeAttr('disabled');
      } else {
        $('.payment-form').append("<input type='hidden' name='stripeToken' value='" + response['id'] + "'/>");
        $('.payment-form').get(0).submit();
      }
    }

    /* <![CDATA[ */
        (function() {
            var s = document.createElement('script'), t = document.getElementsByTagName('script')[0];
            s.type = 'text/javascript';
            s.async = true;
            s.src = 'http://api.flattr.com/js/0.6/load.js?mode=auto';
            t.parentNode.insertBefore(s, t);
        })();
    /* ]]> */

#masthead.hero.sidekick
  .container
    .row
      %h1
        Share the love.
      %p.lead
        Three Easy Ways to Donate

      %div{:style => "text-align:center;"}
        = image_tag 'money.png', :height => 132, :width => 147

.container
  %section#donations-pane
    .row
      .span16
        .alert-message.block-message.error
          %p
            Hi folks -- We're sorry to say that PayPal has frozen our account, so we're currently unable to process contributions by credit card. We're working as fast as we can to resolve this, and will have an alternative up ASAP.  In the meantime, if you are able to contribute via Flattr, please do. PayPal is notorious for arbitrary blocking of legitimate donations.  We'll get this sorted out as quickly as we can.

    .row
      .span8
        .row
          .span8
            %h2
              Why your donation matters
            %p
              We’re building the future we want to see -- a new social web that keeps you in control of your data, giving you the freedom to do what you want and have fun.
            %p
              We’re a tiny core team of developers working our tails off, and we’re also a huge community effort, with more than 150 people having contributed code to our open-source software, hundreds of others engaged in community organizing and spreading the word, and thousands of people providing feedback and financial support.
        .row
          .span8
            %h2
              How we use your money
            %p
              Here's
              = link_to 'a statement', 'http://dl.dropbox.com/u/345057/DIASPORA%207312011%20Profit%20and%20Loss%20Statement%20B.pdf'
              showing how we spent the first $200k we raised via Kickstarter --
              And here's a
              = link_to 'great analysis of it from ReadWriteWeb.', 'http://www.readwriteweb.com/cloud/2011/10/the-state-of-diaspora-and-fund.php'
        .row
          .span8
            %h2
              We can’t do this without you
            %p
              Please give what you can.  Thank you.
      .span8
        %ul{:class=> 'tabs', :data => {:tabs => 'tabs'}}
          %li{:class => 'active'}
            = link_to 'One Time', '#one_time'
          %li
            = link_to 'Monthly', '#monthly'
          %li
            = link_to 'Flattr', '#flattr'

        #donations.tab-content.row
          #one_time.active.span8
            :erb
                <form name="_xclick" action="/donate" class='payment-form form-stacked' method="post">
                  <fieldset>
                    <legend>
                      One Time Donation
                    </legend>

                    <div class="alert-message error" style="display:none;">
                      <p></p>
                    </div>

                    <div class='clearfix'>
                      <div class='input'>
                        <input type="hidden" name="cmd" value="_xclick">
                        <input type="hidden" name="business" value="donations@joindiaspora.com">
                        <input type="hidden" name="item_name" value="Contribution To Diaspora">
                        <input type="hidden" name="currency_code" value="USD">
                        <input type="input" class='xlarge span2' name="amount" value="<%=donation_prefill%>">
                      </div>
                    </div>

                    <div class='clearfix'>
                      <label for='number'>Card number</label>
                      <div class="input"><input type="text" class='card-number large' /></div>
                    </div>

                    <div class='clearfix'>
                      <label for='exp_month'>Expiration (MM/YYYY)</label>
                      <div class="input">
                        <select class='card-expiry-month' style="width:50px">
                          <option value="1">1</option>
                          <option value="2">2</option>
                          <option value="3">3</option>
                          <option value="4">4</option>
                          <option value="5">5</option>
                          <option value="6">6</option>
                          <option value="7">7</option>
                          <option value="8">8</option>
                          <option value="9">9</option>
                          <option value="10">10</option>
                          <option value="11">11</option>
                          <option value="12">12</option>
                        </select>

                        <select class='card-expiry-year' style="width:70px">
                          <option value="2011">2011</option>
                          <option value="2012">2012</option>
                          <option value="2013">2013</option>
                          <option value="2014">2014</option>
                          <option value="2015">2015</option>
                          <option value="2016">2016</option>
                          <option value="2017">2017</option>
                          <option value="2018">2018</option>
                          <option value="2019">2019</option>
                          <option value="2020">2020</option>
                          <option value="2021">2021</option>
                          <option value="2022">2022</option>
                        </select>
                      </div>

                      <div class='clearfix'>
                        <label for='cvc'>Card verification code</label>
                        <div class="input"><input type="text" class='card-cvc' style="width:50px" /></div>
                      </div>
                  </fieldset>
                  <div class='actions'>
                    <input type="submit" class="btn success" value="Donate">
                  </div>
                </form>

          #monthly.span8
            :erb
              <form action="https://www.paypal.com/cgi-bin/webscr" class='form-stacked' method="post">
              <fieldset>
                <legend>
                  Monthly Subscription
                </legend>
                  <input type="hidden" name="cmd" value="_s-xclick">
                  <input type="hidden" name="hosted_button_id" value="N24UFDL4RJJF4">
                  <input type="hidden" name="on0" value="">
                  <div class='clearfix'>
                    <div class='input'>
                      <select name="os0">
                        <option value="Supporter">Supporter : $5.00USD</option>
                        <option value="Member">Member : $10.00USD</option>
                        <option value="Freedom Fighter">Freedom Fighter : $20.00USD</option>
                      </select>
                    </div>
                    </div>
                  <input type="hidden" name="currency_code" value="USD">
                </fieldset>

                <div class='actions'>
                  <input type="submit" class="btn success" value="Donate">
                </div>
              </form>

          #flattr.span8
            %form{:class => 'form-stacked'}
              %fieldset
                %legend
                  Flattr
              :erb
                <a class="FlattrButton" style="display:none;" href="https://flattr.com/profile/Diaspora"></a>
                <noscript><a href="http://flattr.com/thing/382291/Diaspora-on-Flattr" target="_blank">
                <img src="http://api.flattr.com/button/flattr-badge-large.png" alt="Flattr this" title="Flattr this" border="0" /></a></noscript>

